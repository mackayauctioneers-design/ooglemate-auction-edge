# Memory: logic/sourcing/fingerprint-replication-engine-phase-1
Updated: now

## Architecture
Pickles Ingest Cron v5 â†’ Structured Extract (Firecrawl JSON schema) â†’ vehicle_listings upsert â†’ Fingerprint Replication â†’ opportunities upsert â†’ Slack alert

## Platform Integrity (NEW)
- derive_platform() function enforces platform identity
- Prado NEVER matches LandCruiser (separate platforms)
- LandCruiser split: LC300 (2022+), LC200 (2008-2021), LC_OTHER
- Outlander has its own platform key
- Platform check is the FIRST gate in candidate filtering

## Strict Match Filters
- Platform: must match (derive_platform)
- Make: exact (case-insensitive)
- Model: exact (case-insensitive)
- Trim class: exact OR one-step upgrade via trim_ladder (never downgrade)
- UNKNOWN trims: blocked entirely (both listing and sale sides)
- Year: Â±1
- KM: Â±15,000
- Drivetrain: 4x4 never matches 2WD (UNKNOWN passes)

## Trim Ladder
- Embedded in pickles-ingest-cron as TRIM_LADDER constant
- Covers: LC70/200/300, Prado, Hilux, HiAce, Ranger, Everest, D-Max, MU-X, Triton, Outlander, Navara, Patrol
- Outlander: ES=1, LS=2, ASPIRE=3, EXCEED=4, EXCEED_TOURER=5
- trimAllowed() returns "EXACT" | "UPGRADE" | false
- deriveTrimClass() returns "UNKNOWN" (not _STANDARD) for unrecognised variants

## Title-Based Trim Parsing (NEW)
- Pickles titles parsed for grade keywords before URL-based variant
- Covers: Exceed Tourer, Exceed, Aspire, SR5, Rogue, Raptor, Wildtrak, Kakadu, Sahara, X-Terrain, Workmate, GXL, GX, VX, XLT, XLS, XL, SR, LS, ES
- trimHint overrides URL-parsed variant when available

## Selection (deterministic, no medians)
- Sort candidates: ABS(year diff) ASC â†’ ABS(km diff) ASC â†’ sold_at DESC
- LIMIT 1 (single nearest trade)

## Sanity Guards
- listingPrice >= historicalSale â†’ skip (never flag above-sale listings)
- expectedMargin < $1,500 â†’ skip

## Tiers
- HIGH (priority 1): margin >= $6,000
- HIGH (priority 2): margin >= $4,000
- MEDIUM (priority 3): margin >= $1,500

## Opportunity Fields
- source_type = "replication"
- buy_price = listing asking price
- dealer_median_price = historical buy price
- retail_median_price = historical sale price
- median_profit = expected margin
- notes = JSON with matched_sale_id, km_difference, trim_class, drivetrain, sold_at

## Slack Alerts
- Sent for expected_margin >= $4,000
- Format: ðŸ”´ PICKLES FINGERPRINT MATCH with ask/sold/buy/margin

## Known Issues (FIXED)
- âœ… Prado/LandCruiser bleed â†’ fixed by derive_platform()
- âœ… Base Outlander matching Exceed Tourer â†’ fixed by UNKNOWN fallback + Outlander trim ladder
- âœ… Models not in deriveTrimClass fall to _STANDARD â†’ now returns UNKNOWN, blocked from replication
- Credit guardrail: 150 calls/day, ~5 calls per run, sustainable
