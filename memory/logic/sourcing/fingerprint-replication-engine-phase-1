# Memory: logic/sourcing/fingerprint-replication-engine-phase-1
Updated: now

## Architecture
Pickles Ingest Cron v5 â†’ Structured Extract (Firecrawl JSON schema) â†’ vehicle_listings upsert â†’ Fingerprint Replication â†’ opportunities upsert â†’ Slack alert

## Strict Match Filters
- Make: exact (case-insensitive)
- Model: exact (case-insensitive)
- Trim class: exact OR one-step upgrade via trim_ladder (never downgrade)
- Year: Â±1
- KM: Â±15,000
- Drivetrain: 4x4 never matches 2WD (UNKNOWN passes)

## Trim Ladder
- Embedded in pickles-ingest-cron as TRIM_LADDER constant
- Covers: LC70/200/300, Prado, Hilux, HiAce, Ranger, Everest, D-Max, MU-X, Triton, Navara, Patrol
- trimAllowed() returns "EXACT" | "UPGRADE" | false

## Selection (deterministic, no medians)
- Sort candidates: ABS(year diff) ASC â†’ ABS(km diff) ASC â†’ sold_at DESC
- LIMIT 1 (single nearest trade)

## Sanity Guards
- listingPrice >= historicalSale â†’ skip (never flag above-sale listings)
- expectedMargin < $1,500 â†’ skip

## Tiers
- HIGH (priority 1): margin >= $6,000
- HIGH (priority 2): margin >= $4,000
- MEDIUM (priority 3): margin >= $1,500

## Opportunity Fields
- source_type = "replication"
- buy_price = listing asking price
- dealer_median_price = historical buy price
- retail_median_price = historical sale price
- median_profit = expected margin
- notes = JSON with matched_sale_id, km_difference, trim_class, drivetrain, sold_at

## Slack Alerts
- Sent for expected_margin >= $4,000
- Format: ðŸ”´ PICKLES FINGERPRINT MATCH with ask/sold/buy/margin

## Known Issues
- Models not in deriveTrimClass fall to _STANDARD suffix â†’ can match loosely
- Prado sometimes stored as model=LANDCRUISER variant=Prado (not hitting PRADO branch)
- Credit guardrail: 150 calls/day, ~5 calls per run, sustainable

## Results (first live run)
- 7 strict matches from 64 priced listings
- 3 opportunities created (3 passed margin + sanity gates)
- 3 Slack alerts sent
